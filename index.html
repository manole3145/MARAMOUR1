<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Maisons ≤ 1 200 € — 31620 / 31150 / 31790 (+5 km)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --pri:#111; --acc:#0b5fff; --mut:#666; --bg:#f8f9fb; }
    * { box-sizing:border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:var(--pri); }
    header { padding:16px 20px; background:#fff; position:sticky; top:0; border-bottom:1px solid #e6e8ec; z-index:2; }
    h1 { margin:0 0 4px 0; font-size:18px; }
    .mut { color:var(--mut); font-size:13px; }
    .wrap { max-width:1100px; margin:0 auto; padding:18px; }
    .controls { display:flex; gap:10px; flex-wrap:wrap; margin:8px 0 16px; }
    select, input { padding:8px 10px; border:1px solid #d9dce2; border-radius:10px; background:#fff; }
    .badge { padding:6px 10px; border:1px solid #e6e8ec; border-radius:999px; font-size:12px; color:#555; background:#fff; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(300px,1fr)); gap:14px; }
    .card { background:#fff; border:1px solid #e6e8ec; border-radius:12px; padding:14px; box-shadow:0 1px 2px rgb(0 0 0 / 5%); }
    .cp { font-size:12px; color:var(--mut); }
    .title { font-weight:600; margin:6px 0; }
    .price { font-weight:700; }
    .meta { color:var(--mut); font-size:13px; }
    a { color:var(--acc); text-decoration:none; }
    a:hover { text-decoration:underline; }
    .group { margin:24px 0 10px; font-weight:700; }
    footer { padding:30px 20px; color:#888; font-size:13px; text-align:center; }
  </style>
</head>
<body>
  <header>
    <h1>Maisons à louer ≤ 1 200 € — 31620 / 31150 / 31790 (+5 km)</h1>
    <div class="mut">Agrégation multi-sites, mise à jour automatique (GitHub Actions).</div>
  </header>

  <div class="wrap">
    <div class="controls">
      <select id="communeSelect" title="Filtrer par commune">
        <option value="">Toutes les communes</option>
      </select>
      <select id="triSelect" title="Tri">
        <option value="date_desc">Tri : plus récentes</option>
        <option value="prix_asc">Tri : prix croissant</option>
        <option value="prix_desc">Tri : prix décroissant</option>
      </select>
      <input id="searchInput" placeholder="Rechercher (mot-clé)..." />
      <span class="badge" id="countBadge">0 annonces</span>
    </div>

    <div id="container"><div class="mut">Chargement des annonces...</div></div>
  </div>

  <footer>
    Données collectées automatiquement via GitHub Actions + Playwright. Ce site n’est pas affilié aux plateformes citées.
  </footer>

  <script>
    const DATA_URL = "data/annonces.json";
    let annonces = [];
    let filtered = [];
    let communes = [];

    const byDate = (a,b) => (new Date(b.date_ts||0)) - (new Date(a.date_ts||0));
    const byPrixAsc = (a,b) => (a.prix_num??9e9) - (b.prix_num??9e9);
    const byPrixDesc = (a,b) => (b.prix_num??-1) - (a.prix_num??-1);

    function formatPrix(n){ return (n!=null)? new Intl.NumberFormat('fr-FR').format(n) + " €" : "—"; }

    function applyFilters(){
      const q = document.getElementById('searchInput').value.toLowerCase().trim();
      const c = document.getElementById('communeSelect').value;
      const t = document.getElementById('triSelect').value;
      filtered = annonces.slice();

      if (c) filtered = filtered.filter(r => r.commune === c);
      if (q) filtered = filtered.filter(r => (r.titre||"").toLowerCase().includes(q) || (r.commune||"").toLowerCase().includes(q));

      if (t === 'prix_asc') filtered.sort(byPrixAsc);
      else if (t === 'prix_desc') filtered.sort(byPrixDesc);
      else filtered.sort(byDate);
    }

    function render(){
      applyFilters();
      const container = document.getElementById('container');
      const byCommune = {};
      filtered.forEach(r => {
        byCommune[r.commune] = byCommune[r.commune] || [];
        byCommune[r.commune].push(r);
      });

      let html = '';
      Object.keys(byCommune).sort().forEach(c => {
        html += `<div class="group">${c}</div><div class="grid">`;
        byCommune[c].forEach(r => {
          html += `
            <div class="card">
              <div class="cp">${r.cp_zone??""} • ${r.source??""}</div>
              <div class="title">${r.titre??"Maison 4–7 p"}</div>
              <div class="price">${r.prix_num? formatPrix(r.prix_num) : (r.prix??"")}</div>
              <div class="meta">${r.surface??""} • ${r.pieces??""}</div>
              <div class="meta">${r.date_humaine??r.date??"Date non précisée"}</div>
              <div style="margin-top:8px;">
                <a href="${r.url}" target="_blank" rel="noopener">Voir l’annonce</a>
              </div>
            </div>`;
        });
        html += `</div>`;
      });

      container.innerHTML = html || '<div class="mut">Aucune annonce ne correspond.</div>';
      document.getElementById('countBadge').textContent = `${filtered.length} annonces`;
    }

    async function boot(){
      const res = await fetch(DATA_URL, {cache:'no-store'});
      annonces = await res.json();

      communes = [...new Set(annonces.map(a => a.commune))].sort();
      const sel = document.getElementById('communeSelect');
      communes.forEach(c => {
        const o = document.createElement('option');
        o.value = c; o.textContent = c;
        sel.appendChild(o);
      });

      document.getElementById('communeSelect').addEventListener('change', render);
      document.getElementById('triSelect').addEventListener('change', render);
      document.getElementById('searchInput').addEventListener('input', render);

      render();
    }
    boot().catch(e => {
      document.getElementById('container').innerHTML = '<div class="mut">Erreur de chargement des données.</div>';
      console.error(e);
    });
  </script>
</body>
</html>
